# 11.连接池

在基础版的DataSource实现中，连接和物理数据库是1对1的，当连接关闭，物理连接就被抛弃了。
因此，每个客户端session都会开启、初始化、关闭物理连接。

连接池通过保存一些能够复用的数据库的物理连接缓存来解决这个问题。连接池极大的提高了性能和扩展性，特别是在三层模型里。
在图11-1中，JDBC driver提供了一个 `ConnectionPoolDataSource`的实现以便应用服务用来创建和管理连接池。

![11-1](./imgs/11-01.png)

接下来章节介绍 `ConnectionPoolDataSource, PooledConnection, ConnectionEvent`接口和类。
描述了基础数据源和连接池数据源的一些重要的区别。另外，还讨论了连接池如何能够管理可重用的 `PreparedStatement`对象。

## 11.1 ConnectionPoolDataSource和PooledConnection

通常JDBC driver实现ConnectionPoolDataSource接口，然后应用使用它来创建PooledConnection对象。

代码11-1展示了2个版本的 `getPooledConnection` 接口

```java
public interface ConnectionPoolDataSource {
    PooledConnection getPooledConnection() throws SQLException;
    PooledConnection getPooledConnection(String user, String password) throws SQLException;
    ...
}
```

一个 `PooledConnection` 代表一个到数据库的物理连接。JDBC Driver的实现封装了管理这个连接的所有细节。

当一个客户端调用 `DataSource.getConnection`方法，应用服务使用物理的 `PooledConnection`对象来获得一个逻辑的
`Connection`对象。11-2代码展示了 `PooledConnection` 接口定义

```java
public interface PooledConnection {
    Connection getConnection() throws SQLException;
    void close() throws SQLException;
    void addConnectionEventListener(ConnectionEventListener listener);
    void addStatementEventListener(StatementEventListener listener);
    void removeConnectionEventListener(ConnectionEventListener listener);
    void removeStatementEventListener(StatementEventListener listener);
}
```

当一个应用使用完一个连接，它调用 `Connection.close`关闭一个逻辑连接。但是不会关闭物理连接，物理连接被归还给
连接池。

连接池对客户端透明，是否有连接池对客户端使用无感。

> 注意：当 `Connection.close`被调用，池子里的任何通过 `Connection.setClientInfo`设置的属性都会清空

## 11.2 连接事件

当连接关闭时，要通知连接池管理者回收连接。可以实现 `ConnectionEventListener`接口。
该接口定义了2个方法来响应2类事件：

* `connectionClosed`---当调用 `Connection.close`时触发
* `connectionErrorOccurred`---当严重错误（例如服务器崩溃）导致连接丢失

一个连接池管理者通过 `PooledConnection.addConnectionEventListener`方法将自己注册成监听器。
在返回Connection给应用之前注册。

当相关事件发生时，driver来调用 `ConnectionEventListener`的方法。2个方法都有一个 `ConnectionEvent`参数，可以
用来确定是哪种事件。当连接关闭时，driver通过调用 监听器的`connectionClosed`来通知连接池管理者。

当错误发生时，driver通过调用监听器的 `connectionErrorOccurred`方法来通知监听器并且抛出 `SQLException`.

## 11.3 在三层环境中的连接池


